# 混合扰动策略优化配置（适用于2-3水平离散变量场景）
#
# 使用场景：
# - 6个自变量，每个变量2-3个水平
# - Pool-based主动学习（有限候选池）
# - 20-30次采样预算
# - 序数响应（如Likert量表）或连续响应
#
# 关键改进：
# 1. 启用混合扰动策略（对2-3水平变量使用穷举而非随机采样）
# 2. 增加local_num到6（兼容2水平和3水平变量的LCM）
# 3. 保持原有动态权重机制（λ_t和γ_t）

[EURAnovaPairAcqf]
# ===== 基础参数 =====
main_weight = 1.0  # ✅ 保持默认（符合设计公式）

# ===== 动态λ_t参数（交互效应自适应）=====
use_dynamic_lambda = True  # ✅ 启用动态交互权重
tau1 = 0.7  # r_t上阈值（>0.7时参数不确定，降低交互权重）
tau2 = 0.3  # r_t下阈值（<0.3时参数已收敛，提高交互权重）
lambda_min = 0.1  # 最小交互权重（初期，参数不确定时）
lambda_max = 1.0  # 最大交互权重（后期，参数已收敛时）

# ===== 动态γ_t参数（信息/覆盖平衡）=====
use_dynamic_gamma = True  # ✅ 启用动态覆盖权重

# 【针对20-30次采样预算的优化配置】
gamma_max = 0.5      # 早期高覆盖（前3次）
gamma_min = 0.05     # 后期低覆盖（20次后），聚焦信息增益
tau_n_min = 3        # 3次采样前高覆盖
tau_n_max = 20       # 20次后转向精细化（适配小预算）

# ===== 【核心改进】混合扰动策略参数 =====
# 针对2-3水平离散变量的优化配置
use_hybrid_perturbation = True   # ✅ 启用混合扰动（关键改进）
exhaustive_level_threshold = 3   # 对≤3水平的变量使用穷举
exhaustive_use_cyclic_fill = True  # 循环填充到local_num确保均衡覆盖

# ===== 局部扰动参数 =====
local_jitter_frac = 0.1  # 扰动幅度为范围的10%（保持不变）
local_num = 6            # ⬆️ 增加到6（2和3的最小公倍数，确保均衡覆盖）

# 【为什么local_num=6？】
# - 2水平变量：穷举 [0,1,0,1,0,1] → 每个水平各3次（完全均衡）
# - 3水平变量：穷举 [0,1,2,0,1,2] → 每个水平各2次（完全均衡）
# - 对比local_num=4时：
#   * 2水平：[0,1,0,1] ✓ 均衡
#   * 3水平：[0,1,2,0] ✗ 不均衡（水平0重复2次，水平1、2各1次）

# ===== 交互对配置 =====
# 示例：6个自变量的所有两两交互（共15对）
# 格式：(i,j); (i,k); ...
interaction_pairs = "0,1; 0,2; 0,3; 0,4; 0,5; 1,2; 1,3; 1,4; 1,5; 2,3; 2,4; 2,5; 3,4; 3,5; 4,5"

# ===== 变量类型配置（示例）=====
# 根据实际情况调整：categorical（分类）, integer（整数）, continuous（连续）
# 示例：6个变量均为categorical（2-3水平）
variable_types_list = "categorical, categorical, categorical, categorical, categorical, categorical"

# ===== 覆盖度设置 =====
coverage_method = "min_distance"  # Gower距离的最小距离法（保守策略）

# ===== 随机种子（确保可重复）=====
random_seed = 42

# ===== 调试选项 =====
debug_components = False  # 设为True可查看各分量贡献

# ========================================
# 使用示例
# ========================================
"""
from aepsych.server import AEPsychServer

# 1. 加载配置
with open('configs/hybrid_perturbation_optimized.ini') as f:
    config_str = f.read()

# 2. 创建服务器
server = AEPsychServer()
server.configure(config_str=config_str)

# 3. 【重要】warmup阶段结束后验证序数模型配置
# （仅序数响应模型需要，连续响应可跳过）
from tools.verify_ordinal_model import verify_and_save_report

is_valid = verify_and_save_report(
    server=server,
    output_path="results/ordinal_verification.json",
    min_training_samples=10
)

if not is_valid:
    raise RuntimeError("序数模型配置验证失败！请检查上述警告。")

# 4. 开始EUR采样
for trial in range(25):
    next_x = server.ask()
    outcome = get_subject_response(next_x)
    server.tell(config_str, outcome)
"""

# ========================================
# 对比实验建议
# ========================================
#
# 运行对比实验以量化混合扰动策略的效果：
#
# 1. 基线组：使用 baseline_config.ini（use_hybrid_perturbation=False, local_num=4）
# 2. 实验组：使用当前配置（use_hybrid_perturbation=True, local_num=6）
#
# 评估指标：
# - 效应发现能力：回归模型的R²（是否正确识别主效应/交互效应）
# - 参数估计质量：RMSE、95% CI宽度
# - 选点质量：采集函数的信息增益分布
#
# 预期结果：
# - 混合扰动策略应在2-3水平场景下显著提升效应发现能力
# - 原因：完全覆盖所有离散水平，避免随机采样的遗漏

# ========================================
# 调参建议
# ========================================

# 1. 如果水平数不同（如有4-5水平变量）：
#    → exhaustive_level_threshold = 5（扩大穷举范围）
#    → local_num = LCM(2,3,4,5) = 60（不现实，建议分层处理）
#    → 推荐：只对2-3水平用穷举，4+水平用高斯

# 2. 如果采样预算更小（10-15次）：
#    → tau_n_max = 12（更早转向精细化）
#    → gamma_min = 0.02（更激进的后期精细化）

# 3. 如果采样预算更大（40-60次）：
#    → tau_n_max = 35（保持充分的探索阶段）
#    → gamma_min = 0.1（保守的后期策略）

# 4. 如果不确定交互效应是否存在：
#    → gamma_max = 0.6（提高早期覆盖权重）
#    → 保留所有交互对（不要过滤）
