# 三阶段实验方案

## 实验概览
- **目标**：6因子主效应 + 交互效应分析
- **规模**：30被试 × 25-30次采样 = 750-900数据点
- **方法**：GP主动学习 + 混合效应模型

---

## 阶段1：预热筛选（8人）

### 目的
筛选显著交互对，优化采集函数参数

### 实施
```
8人 × 20次 = 160样本（20%预算）
├── 采样：Maximin LHS（空间填充）
├── 分析：初步混合模型
└── 输出：5-7个候选交互对（p<0.10）
```

### 产出
- 交互对列表：`[(0,1), (2,5), ...]`
- 超参数配置：`lambda_max`, `tau_n_max`
- 主效应初步估计

---

## 阶段2：主动学习（20人）

### 目的
高效探索已筛选的交互效应

### 实施
```
20人 × 30次 = 600样本（73%预算）
├── 前5次：随机采样（100点，基线校准）
├── 后25次：GP主动采样（500点）
│   ├── 采集函数：EURAnovaPair
│   ├── 交互对：预热筛选结果
│   └── 动态权重：λ_t自适应
└── 每被试：独立GP模型
```

### 关键参数
```python
interaction_pairs = [预热筛选的5-7对]
tau_n_max = 21        # 70%位置转向精细化
lambda_max = 1.0      # 从预热学习
gamma_min = 0.05      # 后期聚焦信息
```

---

## 阶段3：验证检验（2人，可选）

### 目的
检验主动学习是否引入系统性偏差

### 实施
```
2人 × 30次 = 60样本（7%预算）
├── 采样：纯随机
├── 分析：独立混合模型
└── 对比：主模型 vs 验证模型系数
```

### 决策规则
- 系数差异 < 20% → 无显著偏差
- 首次使用方法时建议执行
- 预算紧张时可跳过

---

## 样本分配汇总

| 阶段 | 策略 | 被试 | 样本 | 占比 | 随机性 |
|------|------|------|------|------|---------|
| 预热 | LHS | 8 | 160 | 20% | ✅ 完全 |
| 主动-初始 | 随机 | 20 | 100 | 12% | ✅ 完全 |
| 主动-GP | EUR | 20 | 500 | 61% | ❌ 自适应 |
| 验证 | 随机 | 2 | 60 | 7% | ✅ 完全 |

**随机样本总计**：320/820 = 39%（足够LMM分析）

---

## 最终分析

### 混合效应模型
```r
y ~ x0 + x1 + ... + x5 +           # 主效应
    x0:x1 + x2:x5 + ... +           # 筛选的交互
    (1 + x0 + ... | subject_id)     # 随机效应
```

### 输出指标
- 效应系数 ± SE
- p值、95% CI
- 效应量（Cohen's d）
- 个体差异方差

---

## 实施检查清单

### 预热前
- [ ] 定义6因子范围和类型
- [ ] 生成LHS设计矩阵
- [ ] 准备GP模型配置

### 预热后
- [ ] 筛选交互对（p<0.10）
- [ ] 提取超参数（λ_max, r_t）
- [ ] 验证主效应估计

### 主动学习
- [ ] 配置采集函数（交互对）
- [ ] 实施前5次随机
- [ ] 监控动态权重变化

### 数据分析
- [ ] 合并所有数据
- [ ] 拟合最终模型
- [ ] 生成效应报告

---

## 关键决策点

| 决策 | 选择 | 理由 |
|------|------|------|
| 预热策略 | LHS | 无偏估计，快速收敛 |
| 交互筛选 | p<0.10 | 平衡探索与效率 |
| 随机基线 | 前5次 | GP初始化+偏差控制 |
| 验证组 | 可选 | 39%随机已足够 |

---

## 风险与缓解

| 风险 | 缓解措施 |
|------|----------|
| GP早期不稳定 | 前5次随机采样 |
| 交互遗漏 | 预热p<0.10（宽松） |
| 主动学习偏差 | 39%随机样本 |
| 个体差异大 | 独立GP建模 |

---

## 快速启动

```python
# 1. 预热
X_warmup = generate_lhs(n=160, d=6)
y_warmup = collect_data(X_warmup, subjects=range(8))
interactions = screen_interactions(X_warmup, y_warmup, p_threshold=0.10)

# 2. 主动学习
for subject in range(8, 28):
    X_random = random_sample(n=5)
    y_random = collect_data(X_random, subject)
    
    gp = fit_gp(X_random, y_random)
    acqf = EURAnovaPair(gp, interaction_pairs=interactions)
    
    for trial in range(5, 30):
        X_next = optimize_acqf(acqf)
        y_next = collect_data(X_next, subject)
        gp.update(X_next, y_next)

# 3. 分析
model = fit_mixed_model(X_all, y_all, subject_ids)
report_effects(model)
```
