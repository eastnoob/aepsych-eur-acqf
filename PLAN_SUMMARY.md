# 修改计划总结（一页版）

## 🎯 你的场景特征
- **目标**：效应发现（不知道哪些主效应/交互效应存在）
- **数据**：混合变量 + Likert量表
- **预算**：20-40次采样
- **策略**：✅ 不确定性采样（当前实现正确）

---

## ✅ 必须修改（2-3小时）

### 1. 修复越界索引验证
**文件**：`eur_anova_pair_acquisition_optimized.py`
**位置**：第235-338行（解析）、第952-965行（forward）
**问题**：交互对索引可能越界，当前在运行时处理，应在解析时过滤
**影响**：
- ✅ 正常输入：零影响
- ⚠️ 异常输入：当前可能崩溃 → 修改后自动过滤+警告

### 2. 修复变换一致性
**文件**：`eur_anova_pair_acquisition_optimized.py`
**位置**：第383-400行（`_ensure_fresh_data`）
**问题**：候选点应用了变换，但扰动范围基于原始数据，导致尺度不匹配
**影响**：
- ✅ 无变换模型：零影响
- 🔴 有StandardScaler等变换：扰动尺度错误，严重影响ANOVA分解

**关键修改**：
```python
# 在 _ensure_fresh_data() 中
X_t_canonical = self._canonicalize_torch(X_t)  # 应用变换
self._X_train_np = X_t_canonical.detach().cpu().numpy()  # 存储变换后数据
```

---

## ⚙️ 强烈建议（1-2小时）

### 3. 调整动态γ_t参数
**文件**：`eur_anova_pair_acquisition_optimized.py`
**位置**：第99-103行（`__init__`默认值）
**问题**：当前 `tau_n_max=40` 适合大预算，你的预算是20-30次

**推荐配置**：
```python
tau_n_max: int = 20  # 从40改为20（或你的预算×0.7）
gamma_min: float = 0.05  # 从0.1改为0.05（后期更聚焦信息）
```

**效果对比**（假设你有25次采样）：
| 配置 | n=25时的γ_t | 信息权重 | 说明 |
|------|------------|---------|------|
| 原始（tau_n_max=40） | 0.28 | 72% | 仍在探索阶段 ⚠️ |
| 调整（tau_n_max=20） | 0.10 | 90% | 充分精细化 ✅ |

---

## 📚 建议增强（2-4小时，可选）

### 4. 增强文档
**目的**：明确说明为什么是 `Di = Ii - I0`（不确定性采样）而非 `I0 - Ii`（信息增益）
**位置**：类文档字符串（第51-74行）

### 5. 添加预算自适应助手
**目的**：自动根据采样预算配置参数
```python
# 使用示例
acqf = EURAnovaPairAcqf_BatchOptimized.from_budget(model, total_budget=25)
```

---

## ❌ 不要修改

| 内容 | 原因 |
|------|------|
| `Di = Ii - I0` | ✅ 正确的不确定性导向策略，适合你的场景 |
| `clamp(min=0)` | ✅ 避免负贡献，语义清晰 |
| 批内标准化 | ✅ 当前EPS保护已足够 |

---

## 🔍 为什么不改为信息增益？

| 维度 | 不确定性采样（当前） | 信息增益（不推荐） |
|------|-------------------|-------------------|
| **适用场景** | ✅ 效应发现、无先验 | ❌ 效应已知、精细化 |
| **探索能力** | ✅ 广泛探索 | ❌ 过早收敛 |
| **鲁棒性** | ✅ 不依赖早期采样 | ❌ 易受噪声误导 |
| **理论支撑** | ✅ Montgomery (2017) DOE | ⚠️ 需要已知效应 |

**你的场景完全符合不确定性采样！**

---

## 📋 实施检查清单

### 阶段1：Bug修复（必须完成）
- [ ] 修复越界验证（修改1）
- [ ] 修复变换一致性（修改2）
- [ ] 测试：无变换模型行为不变
- [ ] 测试：有变换模型扰动尺度正确

### 阶段2：参数优化（强烈建议）
- [ ] 调整 `tau_n_max` 和 `gamma_min`（修改3）
- [ ] 运行 `verify_config.py` 验证γ_t轨迹
- [ ] 确认在你的预算（n≈25）时，γ_t≈0.1

### 阶段3：文档增强（建议）
- [ ] 添加不确定性采样的理论说明（修改4）
- [ ] 可选：添加 `from_budget()` 方法（修改5）

---

## 🎬 快速开始

### 如果你只有时间做最少修改：

**核心3项**（4-5小时）：
1. ✅ 修复变换一致性（最重要！）
2. ✅ 调整 `tau_n_max=20` 和 `gamma_min=0.05`
3. ✅ 测试验证

### 完整修改路线：

**第1周**：Bug修复 + 参数优化 + 验证（6-8小时）
**第2周**：文档增强 + 可选功能（3-4小时）

---

## 📞 需要帮助？

- 查看详细计划：`MODIFICATION_PLAN.md`
- 验证配置：运行 `verify_config.py`
- 理解策略：查看 `strategy_comparison.md`
- 模拟示例：查看 `simulation_example.py`

**核心结论**：你的代码设计理念正确，只需修复2个技术bug并优化参数！
